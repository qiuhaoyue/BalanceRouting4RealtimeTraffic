Title         : 实时路况计算系统
Author        : 张禹

Logo          : True
Email         : zhangrain911@163.com


Doc class     : [10pt]article


[TITLE]


[TOC]


# 1. 系统框架图 {-}

![new_framework]

[new_framework]: images/new_framework.jpg "new_framework" { width:auto; max-width:90% }



黄色部分为线程的一次执行,棕红色为路况结果。


# 2. 模块说明 {-}

## 2.1 模拟数据发送: {-}
按照GPS点的utc时间进行发送，发送当前时间的GPS点，并休眠直至下一个点的utc。24小时数据24小时发送完毕，后续进行2倍速（当前1秒发送后续2秒的数据，以此类推），4倍速的测试。

## 2.2 出租车队列: {-}
系统接受出租车数据后根据suid放入对应的出租车队列，等待线程进行处理，若该suid第一次出现，则将该suid随机添加至某一线程的出租车列表。

  输入：原始GPS流(suid, utc, lat, lon, head, ostdesc)(省略某些不用的属性)
  
  输出：按suid分割的GPS流，GPS点按照suid存入内存队列。

## 2.3 线程： {-}
程序开始时即按系统资源创建n个线程，每个线程维护一张出租车列表，并以轮询的方式处理列表中出租车队列中的缓存数据。
  
  
输入：出租车suid以及该辆出租车队列中的缓存数据。
  
输出：启动一个线程，根据轨迹序列进行路况计算。
  
## 2.4 预处理: {-}
对将要进行匹配的点进行简单的预处理，包括点的时间顺序判断，通过与前一个点的比较判断是否存在暂停，是否超时（若与前一个点的时间间隔超过阈值，将清空之前的点）

  输入：原始GPS点
  
  输出：可用的GPS的点
  
## 2.5 OHMMM道路匹配出租车队列： {-}
在线的HMMM匹配，有一定延迟，目前设定的匹配窗口最大值为5（若1分钟一个点，则延迟最大为5分钟）。输出的GPS点带有
  Gid，Edge_offset,route三个字段，分别表示将这个点匹配的道路id，偏移以及这个点的前一个点到当前sample通过的路径。
  
  
  输入：GPS点
  
  输出：输出添加了Gid, Edge_offset, route 3个属性的GPS点。

 
  
## 2.6 实时路况计算模块： {-}
根据新获取的GPS点计算路况。如果与上一个GPS点在同一道路上则直接更新该道路路况，如果上一个点不在
同一道路上，则需要先计算与上一个点之间的路由，并更新路由上所有道路的路况，具体见3.4节的实时路况计算算法
  
  输入：单个GPS点。
  
  输出：更新内存中的实时路况。
  


## 2.7 路况推测模块： {-}
如果道路2个阶段路况间没有探测到路况，且2个阶段时间间隔在阈值范围内，则进行路况推测。
根据历史路况以及道路上一个阶段的路况推测之后2个阶段(10分钟)的路况，如果推测的阶段有路况，
则对路况进行修正，否则直接插入数据库。

  输入：历史路况与已有的道路路况
  
  输出：推测出的道路路况

  
## 2.8 GPS备份： {-}
为实验需求，对处理完的GPS进行备份，未匹配成功的GPS同样进行备份，供后续的新道路挖掘。
    
输入：处理完毕的GPS流(suid, utc, lat, lon, head, ostdesc, stop, Gid, Edge_offset, route, interval, pre_gid, ore_offset)
    
输出：写入GPS数据库。
    

# 3. 核心算法 {-}
## 3.1 轨迹长暂停标记： {-}

![label_stop]

[label_stop]: images/label_stop.jpg "label_stop" { width:auto; max-width:90% }


设定一个距离阈值，时间阈值。

      for point in GPS sequence:
        以当前点为基准，选出在该点之前且距离在阈值内的所有点作为集合A；
        for point in A:
          求出集合A中的点与当前点的时间间隔；
        将时间间隔大于阈值的点标记为长暂停；
        
## 3.2 道路匹配： {-}
算法参考论文：“Online map-matching based on Hidden Markov model for real-time traffic sensing applications”

  实现：[在线的HMMM算法]，在这基础上可能会进一步修改。
 
## 3.3 路况计算： {-}


![update_traffic]

[update_traffic]: images/update_traffic.jpg "update_traffic" { width:auto; max-width:90% }


    如图所示，对于未切换道路的点，直接计算当前道路的路况即可，道路改变的点需要对路由上的每一条道路的路况进行计算
    
    1.当前点与前一个点在同一条道路上；
		if offset = 0 && 道路速度 < 交通拥塞的速度阈值:
		  道路速度 = 道路速度 * 0.9；
		探测速度 = offset * 道路长度 / 间隔；
		平滑速度 = 道路速度 * 0.9 + 探测速度 * 0.1；
			
  
    2.道路改变；

        获取当前点与上一个点的路由；
        for each road in route://遍历出租车从上一个点到当前点经过的所有道路
          计算出租车在道路上的覆盖率;
          根据覆盖率计算在当前道路上消耗的时间，具体公式为覆盖率*当前道路长度/道路速度 + 转向时间;
          将算得的时间累加到totaltime;
        for each road in route that has coverage://所有成功算出覆盖率的道路，可能有路段出现异常
          计算当前道路的通过时间以及到下一条道路的转向时间的和在total_time中的比重，具体公式为：
		  percentage = (覆盖率*当前道路长度/道路速度 + 转向时间) / total_time;
		  计算实际花费的时间 real_time = interval(当前点与上一个点的时间间隔) * percentage；
		  按比例分配行驶时间与转向时间；例如 转向时间 = real_time * 转向时间/(转向时间 + 行驶时间)；
    
  

 
## 3.4 路况推测： {-}


# 4. 相关工作调研 {-}

1. Real-time freeway traffic state estimation based on extended Kalman filter: a general approach

  对于高速公路上的路况计算采用模型(extended Kalman filter)的方式估计各类变量，但高速公路的情况较为简单，该方法在城市中不适用。

2. Real-Time Traffic Volume Estimation with Fuzzy Linear Regression
  
  同样是基于模型，对交通流量进行预测，较为精确，但模型的输入是道路的流量与拥挤程度，对于浮动车来说无法直接获取到这2种信息。

3. Study on Vehicle Navigation System with Real-time Traffic Information

  利用探测车来探测，由中心节点进行汇总，计算路况，并提供导航。具体如何计算路况或导航并没有介绍。除了静态路段外，根据路况以及道路的属性进行动态的道路分段(可能跨越多个物理道路)。实验也是在北京做的。

4. Traffic Estimation And Prediction Based On Real Time Floating Car Data

  基于600，000辆私家车gps数据的实时路况系统，3分钟更新一次，通过网页可以获取，主要是针对意大利的摩托车道和一些主干道。

  道路匹配(经纬度和方向)->计算路由->计算路由道路上的时间，与我们的计算过程类似，但并没有给出具体实现，最后提供了几种估计未来路况的方法。

5. Real-time urban traffic monitoring with global positioning system-equipped vehicles

  使用point-to-curve道路匹配算法(做了改进)。使用eSMS（estimated space mean speed）并将其转换为更合理的路况量度

  1.道路匹配后的预处理：存储gps点，相同路段的点存在同一个数据结构中，对于每一个数据结构(对应一个路段),计算其第一个点到每个点的曲线距离，并作为gps点的一个属性存储。
  
  2.求eSMS：将某一路段上的点的速度曲线近似为2次方程。但计算路况时只取其平滑的部分(对加速度做限制)作为参考，并计算平均速度。最后对所有车的速度求eSMS。同一条道路有连续多个点时才能这样计算
  。
  
  3.将eSMS转化为一个更合理的smooth index(0,1之间，0表示拥堵，1表示畅通)

  实验：上海6000辆出租车。该方法将状态为空车的出租车数据丢弃，每4分钟算一次，没有考虑不同道路之间的路由。通过视频来人工判断路况，分5个等级，时间花费也较低

6. (1)Real-time Urban Traffic Sensing with GPS Equipped
Probe Vehicles (2) Scaling the Real-time Traffic Sensing with GPS Equipped Probe Vehicles

  在storm上部署实时路况探测，同样丢弃了空车的数据点，使用HMMM进行道路匹配，Fuzzy C-Means Clustering algorithm来去除一些不正常的行驶行为对路况的影响，将车辆探测到的速度分为2组，高速与低速，只有规模大的那一组会被采用。道路匹配是最耗时的部分

7. Traffic State Detection with Floating Car Data in Road Networks

  考虑了trafic center和出租车的信息交互过程。最小化信息交互次数，出租车在本地判断是否将该车在某一道路上的travel time（进入道路与离开道路的时间差）上传至中心(若travel time与本地已知的time差距大于某一阈值，则上传)。
出租车在离开道路后上传路况，中心需要对时间做修改，比如10：45上传出租车通过道路A需要30分钟，那么该路况同时也是10：15得路况。

  对路况做预测，并做动态导航
以预测为主，出租车的数据用于纠正历史信息，所以始终是有延迟的

# 5. 改进方向 {-}

  1. 计算当前的实时路况，不对点做分割，接受一个点处理一个点，另外有另一个进程进行延时处理，
进行轨迹切割(切割的时机可能有：1.长暂停，避免探测的路况与当前相隔太久而没有参考价值 2.行驶的道路发生了改变，道路改变后需要保留上一条道路的信息)，
计算更精准的路况(轨迹多，道路匹配更精确，借此导出的路由也更准确)，并根据该路况对实时路况进行反馈(如果道路相同，速度有出入，则对速度进行修正，如果道路不同，则尽量消除之前由该轨迹探测的路况对当前路况的影响)。

  2. 因为一条道路总的路况分为路口转向时间与行驶时间，路口信号的影响可以不用考虑，包含在转向延迟里。
  
  3. 对于无法正确匹配但本身没有异常的点单独存一份，用作以后挖掘新的道路。例子：(12788,2010-04-06 00:00:24)	lat:39.91935,lon:116.53758,head:357,speed:22.12,distance:0,min_matching_distance:-1.0, (12788,2010-04-06 00:01:24)	lat:39.93131,lon:116.53687,head:357,speed:22.12,distance:0,min_matching_distance:-1.0, (12788,2010-04-06 00:02:24)	lat:39.9396,lon:116.53815,head:72,speed:15.43,distance:0,min_matching_distance:-1.0, (12788,2010-04-06 00:03:19)


# 6. 实验日志 {-}

## 6.1 处理速度 {-}

路况数量在更新临界点（5分钟）时有一定随机性，更新路况时容许比当前seq-1的路况更新，即最迟10分钟前的路况

模拟数据发送，按gps点的utc发送数据，在正常速度，2倍，4倍, 8倍发送速率下探测到的路况数量为：

![traffic_number_total]

[traffic_number_total]: images/traffic_number_total.png "traffic_number_total" { width:auto; max-width:90% }

由于更改道路拆分标准后道路变少，4倍速度也基本能够处理，8倍速度时，在数据高峰期偏差明显。

探测到的道路平均速度为：

![average_speed_comparison]

[average_speed_comparison]: images/average_speed_comparison.png "average_speed_comparison" { width:auto; max-width:90% }

由于现在尚未添加道路的初始速度获取，所以从凌晨开始需要一定的时间进行迭代才能接近真实路况。

## 6.2 窗口大小对匹配精确度的影响 {-}

统计同一条道路和不同道路的路况数：

同一条道路：177312，数量少但质量高

不同道路：2742406，占94%，如果一个点匹配错，将会导致路由的错误，从而影响探测到的路况的错误（扩大）

匹配窗口大小实验，选取suid小于1500的447辆出租车轨迹，与离线的HMMM比较，静止不动的点只处理一次，未对超时点做处理。对不同窗口大小下的匹配差错率以及由此计算出的路由差错率进行比较

![map-matching_comparison]

[map-matching_comparison]: images/map-matching_comparison.png "map-matching_comparison" { width:auto; max-width:90% }

由于匹配错误的道路与正确道路往往较为接近，所以即使道路匹配错误，仍有一部分路由重合，路由的错误率只有道路
匹配错误率的1/5左右，但是由此探测出的道路速度同样会出现偏差(可能需要补充不同窗口大小下探测出的平均速度？).

另外，由于窗口的变大，实时算法遗留在窗口中的点变多，可比较的点变少，所以会有一定抖动。

目前看，窗口大小设置为6或7比较合理（窗口增大，匹配平均延迟不变，但最大延迟会增加）


## 6.3 窗口大小对探测到的道路速度的影响 {-}

不同窗口大小下的平均速度几乎吻合

由于窗口大小变大之后，延迟增加，而每5分钟划分一次路况粒度太细，比较不同窗口大小下的路况意义不大，效果也不好，所以不以时间为单位，以每条路一天的平均路况为单位计算。
以窗口大小12为baseline，窗口大小为6时效果突出

道路一天速度的平均差错率以及探测到的不同道路路况的数量：

0.5982770077347543; 7764.0

<!-- begin merge (remove this line to resolve the conflict) -->
~ Begin Remote
0.20345720192456906; 1427.0

0.6037075364477941; 7601.0

0.5962989321010983; 7373.0

计算间隔为60分钟的路况，且两两比较，4与6，6与8，以此类推

0.6335721425201148; 7483.0

0.5386980322977708; 7227.0

0.5446761308567067; 7620.0

0.5351924154831883; 7388.0

窗口变大，一方面匹配精确度有提高，另一方面，由于遗留在窗口中的点变多，又导致实时路况的不精确，很难去找出一个精确地解作为baseline。

由匹配精确度的图以及上述结论，暂时以6作为窗口大小算一周数据，尽量补充缺失的路况。

~ End Remote
匹配窗口大小实验，选取suid小于1500的447辆出租车轨迹，与离线的HMMM比较，静止不动的点只处理一次，未对超时点做处理。对不同窗口大小下的匹配差错率以及由此计算出的路由差错率进行比较
<!-- end merge -->

## 6.4 双向道路的拆分 {-}

更新了osm2pgrouting的版本到2.1，新版本对于oneway的处理较好，导入的表中保留有one_way字段（0-未知,1-单向,2-双向,-1-单向但是几何上方向是相反的）

共有87377条道路one_way为0的有52139，-1的有101,1的有34636,2的有501条。拆分完后共140121条道路。


## 6.5 道路初始速度的获取 {-}
一周数据路况图： 0201和0208的路况有抖动。

![week_0201-04]
![week_0205-08]
![history_traffic]

[history_traffic]: images/history_traffic.png "history_traffic" { width:auto; max-width:90% }


[week_0201-04]: images/week_0201-04.png "week_0201-04" { width:auto; max-width:90% }

[week_0205-08]: images/week_0205-08.png "week_0205-08" { width:auto; max-width:90% }


系统启动时从历史库信息中获取当前时间段已知的路段信息，对于未知的路段，使用同等级别道路的平均速度作为初始值.
运行数据后当天的路况会自动写入历史库。

使用一周的数据(0201-0208)生成历史库信息，共5940900条路况，由于探测到的路况在开始时不精确，所以再次
运行数据时0点的初始路况使用23:55-24:00的路况作为初始值。

加入系统初始值后一天的路况分析(0202)：
总的路况： ![init_week_0202]

不同类型道路的路况比较： ![week_0202]

总共有28类道路，探测到的路况主要在如下类别的道路上

| class_id  |  name  | 路况数
|:----|:---------:|:------:|
| 104 | trunk     | 172747 |
| 106 | primary   | 162314 |
| 108 | secondary | 343078 |
| 109 | tertiary  | 575388 |
| 110 | residential  | 174404 |



[week_0202]: images/week_0202.png "week_0202" { width:auto; max-width:90% }

[init_week_0202]: images/init_week_0202.png "init_week_0202" { width:auto; max-width:90% }
<!-- end merge -->

## 6.6 道路速度的补充 {-}

在历史路况与当前探测到的道路速度的基础上，对之后2个时间段（10分钟）的道路速度进行推测，如果之后2个时间段
没有探测到的路况，则直接将推测的路况插入，否则对探测到的路况进行修正。详细见道路补充算法。

补充的路况目的是增加路况数量，平均速度应尽量与探测到的路况接近。
![infer_week_0207(2)]

[infer_week_0207(2)]: images/infer_week_0207(2).png "infer_week_0207(2)" { width:auto; max-width:90% }
探测出的路况与根据历史路况推测出的路况的比较。


[在线的HMMM算法]: https://github.com/bmwcarit/barefoot


